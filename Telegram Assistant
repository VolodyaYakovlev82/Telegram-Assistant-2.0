import telebot, wikipedia, re

import subprocess

import datetime

from datetime import datetime

from pyowm import OWM

from telebot import types

bot_token = "5666629244:AAFb3q6mWoudKWe0JxJQmxPwe7CT4C0MgqE"


bot = telebot.TeleBot(bot_token)

@bot.message_handler(commands=["start"])
def Start(message):
 if message.text == "/start":
   markup = types.InlineKeyboardMarkup()

   button111 = types.InlineKeyboardButton("–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º?", callback_data="–ö–Ω–æ–ø–∫–∞111")
   button112 = types.InlineKeyboardButton("–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É", callback_data="–ö–Ω–æ–ø–∫–∞112")
   button113 = types.InlineKeyboardButton("–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?", callback_data="–ö–Ω–æ–ø–∫–∞113")
   button114 = types.InlineKeyboardButton("Premium-–ø–æ–¥–ø–∏—Å–∫–∞", callback_data="–ö–Ω–æ–ø–∫–∞114")
   button115 = types.InlineKeyboardButton("–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞", callback_data="–ö–Ω–æ–ø–∫–∞115")
   button116 = types.InlineKeyboardButton("–°–≤—è–∑—å —Å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º", callback_data="–ö–Ω–æ–ø–∫–∞116", url="https://t.me/VolodyaYakovlev82")

   markup.add(button111, button112, button113, button114, button115, button116)

   file_photo = open('photo_5206556225083392265_y.jpg', 'br')
   bot.send_photo(chat_id=message.from_user.id, photo=file_photo, caption="""–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, –¥–æ—Ä–æ–≥–æ–π –¥—Ä—É–≥!üòÑ
–ú–µ–Ω—è –∑–æ–≤—É—Ç –¢–µ–ª–µ–≥—Ä–∞–º–º –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∏ —è —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫! –Ø –ø–æ–º–æ–≥—É –≤–∞–º —É–∑–Ω–∞—Ç—å –ø–æ–≥–æ–¥—É –Ω–∞ —Å–µ–≥–æ–¥–Ω—è, –≤—Ä–µ–º—è –∏–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –ª—é–±–æ–π –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã. –ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–∞ –º–æ—è –ø–æ–º–æ—â—å, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ /help.üòâ""", reply_markup=markup)

   @bot.callback_query_handler(func=lambda call: True)
   def Call(call):
    if call.data == "–ö–Ω–æ–ø–∫–∞112":

      markup = types.InlineKeyboardMarkup()

      button1 = types.InlineKeyboardButton("üòÅ–ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–¥–Ω—è—Ç–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—èüòÅ", callback_data="–ö–Ω–æ–ø–∫–∞1")
      button2 = types.InlineKeyboardButton("‚åöÔ∏è–ö–æ—Ç–æ—Ä—ã–π —á–∞—Å?‚åöÔ∏è", callback_data="–ö–Ω–æ–ø–∫–∞2")
      button3 = types.InlineKeyboardButton("üå§–ü–æ–≥–æ–¥–∞ —Å–µ–≥–æ–¥–Ω—èüå§", callback_data="–ö–Ω–æ–ø–∫–∞3")
      button4 = types.InlineKeyboardButton("ü§î–ü–æ–¥—Å–∫–∞–∂–∏, —á—Ç–æ –∑–∞ —Å–ª–æ–≤–æ?ü§î", callback_data="–ö–Ω–æ–ø–∫–∞4")
      button5 = types.InlineKeyboardButton("üí∏–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ —Å–µ–≥–æ–¥–Ω—èüí∏", callback_data="–ö–Ω–æ–ø–∫–∞5", url='https://t.me/Grogu_Weather_Bot')
      button6 = types.InlineKeyboardButton("üòè–ï—â—ë...üòè", callback_data="–ö–Ω–æ–ø–∫–∞6")

      markup.add(button1, button2, button3, button4, button5, button6)

      bot.send_message(call.message.chat.id, "–ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω —Å–ø–∏—Å–æ–∫ —Ç–æ–≥–æ, —á–µ–º —è –º–æ–≥—É –±—ã—Ç—å –≤–∞–º –ø–æ–ª–µ–∑–µ–Ω. –î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–π –≤–∞–º —Ñ—É–Ω–∫—Ü–∏–∏.ü§ñ", reply_markup=markup)

    @bot.message_handler(commands=['date'])
    @bot.callback_query_handler(func=lambda call: True)

    def Call(call):
      if call.data == "–ö–Ω–æ–ø–∫–∞2":
        bot.send_message(call.from_user.id, f"‚è∞Ô∏è–í—Ä–µ–º—è: {datetime.now(tz=None)}")
    if call.data == "–ö–Ω–æ–ø–∫–∞2":
      bot.send_message(call.from_user.id, f"‚è∞Ô∏è–í—Ä–µ–º—è: {datetime.now(tz=None)}")
    if call.data == "–ö–Ω–æ–ø–∫–∞1":
      file_photo = open('2014_12_06_ac131f3673b6102b5bba6cf885a50e68.jpg', 'br')
      bot.send_photo(chat_id=call.from_user.id, photo=file_photo)
    if call.data == "–ö–Ω–æ–ø–∫–∞3":
      msg = bot.send_message(call.message.chat.id, "üåè–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞")
      bot.register_next_step_handler(msg, get_weather)
    if call.data == "–ö–Ω–æ–ø–∫–∞6":

      markup = types.InlineKeyboardMarkup(row_width=3)

      button7 = types.InlineKeyboardButton("üßÆ–ö–∞–ª—å–∫—É–ª—è—Ç–æ—ÄüßÆ", callback_data="–ö–Ω–æ–ø–∫–∞7", url='https://t.me/Grogu_Beta_Bot')
      button8 = types.InlineKeyboardButton("üì∞–ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏üì∞", callback_data="–ö–Ω–æ–ø–∫–∞8")
      button9 = types.InlineKeyboardButton("‚è≥Ô∏è–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞‚è≥Ô∏è", callback_data="–ö–Ω–æ–ø–∫–∞9")

      markup.add(button7, button8, button9)

      file_photo = open('photo_5206556225083392265_y–æ—Ä.jpg', 'br')
      bot.send_photo(chat_id=call.from_user.id, photo=file_photo, caption="–î–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±—É—é –∏–∑ –Ω–∏—Ö, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.üõ†", reply_markup=markup)

      @bot.message_handler(commands=['date'])
      @bot.callback_query_handler(func=lambda call: True)
      def Call(call):
        if call.data == '–ö–Ω–æ–ø–∫–∞7':
          bot.send_message(call.message.chat.id, '–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä')
    if call.data == '–ö–Ω–æ–ø–∫–∞8':
      bot.send_message(call.message.chat.id, '–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Ñ—É–Ω–∫—Ü–∏—è "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏" –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ.ü§∑‚Äç‚ôÇÔ∏è')
    if call.data == '–ö–Ω–æ–ø–∫–∞9':
      bot.send_message(call.message.chat.id, '–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Ñ—É–Ω–∫—Ü–∏—è "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞" –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞: —Å–µ–Ω—Ç—è–±—Ä—å 2022 –≥–æ–¥–∞.üôÇ')
    if call.data == "–ö–Ω–æ–ø–∫–∞5":
      bot.send_message(call.message.chat.id, 'üíµ–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ —Å–µ–≥–æ–¥–Ω—èüíµ')
    if call.data == "–ö–Ω–æ–ø–∫–∞4":
      bot.send_message(call.message.chat.id, 'üîé–û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ –ª—é–±–æ–µ —Å–ª–æ–≤–æ, –∏ —è –Ω–∞–π–¥—É –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ Wikipedia')
@bot.message_handler(content_types=["text"])
def handle_text(message):
    bot.send_message(message.chat.id, getwiki(message.text))


def get_weather(message):
    city = message.text
    try:
        w = weather(city)
        bot.send_message(message.from_user.id, f'''üèô–í –≥–æ—Ä–æ–¥–µ {city} —Å–µ–π—á–∞—Å {round(w[0]["temp"])}¬∞C.
üå°–ß—É–≤—Å—Ç–≤—É–µ—Ç—Å—è –∫–∞–∫ {round(w[0]["feels_like"])}¬∞C.
ü•µ–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç {round(w[0]["temp_max"])}¬∞C.
ü•∂–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç {round(w[0]["temp_min"])}¬∞C.''')
        bot.send_message(message.from_user.id, w[1])
        bot.send_message(message.from_user.id, "üó∫–•–æ—Ç–∏—Ç–µ –ø–æ–∏—Å–∫–∞—Ç—å –ø–æ–≥–æ–¥—É –≤ –¥—Ä—É–≥–æ–º –≥–æ—Ä–æ–¥–µ?")
        bot.register_next_step_handler(message, get_weather)
    except Exception:
        bot.send_message(message.from_user.id,'üò¢–£–ø—Å... –¢–∞–∫–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –Ω–µ—Ç –≤ –±–∞–∑–µ, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑')


def get_location(lat, lon):
  url = f"https://yandex.ru/pogoda/maps/nowcast?lat={lat}&lon={lon}&via=mmapwb&le_Lightning=1"
  return url

def weather(city: str):
    owm = OWM('b06f341c1e172798c4819a98f859c30b')
    mgr = owm.weather_manager()
    observation = mgr.weather_at_place(city)
    weather = observation.weather
    location = get_location(observation.location.lat, observation.location.lon)
    temperature = weather.temperature("celsius")
    return temperature, location

wikipedia.set_lang("ru")

def getwiki(s):
    try:
        ny = wikipedia.page(s)

        wikitext=ny.content[:1000]

        wikimas=wikitext.split('.')

        wikimas = wikimas[:-1]

        wikitext2 = ''

        for x in wikimas:
            if not('==' in x):

                if(len((x.strip()))>3):
                   wikitext2=wikitext2+x+'.'
            else:
                break

        wikitext2=re.sub('\([^()]*\)', '', wikitext2)
        wikitext2=re.sub('\([^()]*\)', '', wikitext2)
        wikitext2=re.sub('\{[^\{\}]*\}', '', wikitext2)

        return wikitext2

    except Exception as e:
      return 'üò¢–í —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —ç—Ç–æ–º'

bot.polling(none_stop=True, interval=0)
